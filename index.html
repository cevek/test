<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <script src="weakmap.js" type="text/javascript"></script>
</head>
<body>

<div id="test"></div>

<script type="text/javascript">
    // Original - @Gozola. This is a reimplemented version (with a few bug fixes).
    window.WMM = (function () {
        var privates = Name()

        return {
            get: function (key, fallback) {
                var store = privates(key)
                return store.hasOwnProperty("value") ?
                        store.value : fallback
            },
            set: function (key, value) {
                privates(key).value = value
            },
            has: function(key) {
                return "value" in privates(key)
            },
            "delete": function (key) {
                return delete privates(key).value
            }
        };

        function namespace(obj, key) {
            var store = { identity: key },
                    valueOf = obj.valueOf

            Object.defineProperty(obj, "valueOf", {
                value: function (value) {
                    return value !== key ?
                            valueOf.apply(this, arguments) : store
                },
                writable: true
            })

            return store
        }

        function Name() {
            var key = {}
            return function (obj) {
                var store = obj.valueOf(key)
                return store && store.identity === key ?
                        store : namespace(obj, key)
            }
        }
    }())
</script>


<script>




var jj = 0;


function getVVVValue() {

    var ff = getVVVValue;
    while ((ff = ff.caller) && !ff.$id) {
//            console.dir(ff);
    }


//        console.log(this.value, "depends on", ff && ff.$id);
    if (ff) {
        if (!this.slaves)
            this.slaves = {};
        //if (!this.slaves[ff.$id])
        this.slaves[ff.$id] = ff;
        if (!ff.deps) {
            ff.deps = {};
        }

        ff.deps[this.$id] = this;
    }

//        console.log(getVVVValue.caller, this.value);
    return this.value;
}

function afterUpdate(callback) {
    if (!this.listeners)
        this.listeners = [];
    this.listeners.push(callback);
}


function update() {
    this.value = arguments.length ? arguments[0] : this();
    for (var i in this.slaves) {
        this.slaves[i].update();
    }

    if (this.listeners) {
        for (i = 0; i < this.listeners.length; i++) {
            this.listeners[i](this.value, arguments[0]);
        }
    }
}

Atomic.prototype.valueOf = getVVVValue;
Atomic.prototype.update = update;
Atomic.prototype.afterUpdate = afterUpdate;
Atomic.prototype.toString = afterUpdate;

function Atomic(valueFn) {
    if (valueFn.constructor === Function) {
//    valueFn.toString = getVVVValue;
        valueFn.$id = ++Atomic.counter;
        valueFn.value = valueFn();
        valueFn.valueOf = getVVVValue;
        valueFn.update = update;
        valueFn.afterUpdate = afterUpdate;
        return valueFn;
    }
    else {
        this.value = valueFn;
        this.$id = ++Atomic.counter;
    }
}
Atomic.counter = 0;


/*    var ggg = Object.prototype.getOwnPropertyNames;
 Object.defineProperty(Object, 'getOwnPropertyNames', {
 value: function aaaa(obj){
 //return ggg.call(obj);
 }
 });*/

var wm = new WeakMap();
var t = [{1: 1}, {2: 2}, {3: 3}, {4: 4}, {5: 5}];
wm.set(t[0], {a: 1});
wm.set(t[1], {a: 2});
wm.set(t[2], {a: 3});
wm.set(t[3], {a: 4});

var k = wm.get(t[1]);


var count = 10000;
var mainAtom = Atomic(1);
var u = {};
function start() {
//        gc();
    console.profile('AA0');
    console.time('AA0');

    for (var i = 1; i < count; i++) {
        u[i] = new WM();
        u[i].set({a: i}, {a: 123});
        //u[i]  = Object.freeze({hello: i});
        /*u[i] = Atomic(function () {
         return mainAtom.valueOf() + 1
         });*/

//            u[i] = new Atomic('Yes');

    }

    console.timeEnd('AA0');
    console.profileEnd('AA0');
//        gc();
}


var a = new Atomic(1);
var b = new Atomic(function () {
    return a + '2';
});
var c = new Atomic(function () {
    function mm() {
        return b + '3';
    }

    return mm() + mm();
});

var d = new Atomic(function () {
    return '3';
});

var f = d + 1;
console.log(c);


start();


var topAtom = {dom: document.getElementById('test')};


function span(atom, ifAtom) {
    if (atom.constructor !== Atomic)
        new Atomic(atom);

    var parentAtom = span.caller || topAtom;

    function changeListener() {
        console.log('Changed', atom.value);
        atom.dom.innerText = atom.value;
    }

    function bbb() {
        atom.dom = document.createElement('span');
        atom.dom.innerText = atom.value;
        atom.afterUpdate(changeListener);
        parentAtom.dom.appendChild(atom.dom);
    }

    if (ifAtom) {
        if (ifAtom.value)
            bbb();
        else {
            document.removeChild(atom.dom);
            atom.dom = null;
        }

        ifAtom.afterUpdate(function () {
            if (ifAtom.value)
                bbb();
            else {
                atom.dom.parentNode.removeChild(atom.dom);
                atom.dom = null;
            }
        });
    }
    else {
        bbb();
    }
}


var model = {
    firstName: new Atomic('Dima'),
    lastName: new Atomic('Frolov')
};

var showed = new Atomic(true);

span(function () {
    return model.firstName + ' ' + model.lastName;
}, showed);


</script>

<!--<script src="123.js"></script>-->

<!--<script>-->

<!--function setNonEnumerableProps(obj) {-->
<!--Object.defineProperties(obj, {-->
<!--value: {-->
<!--writable: true,-->
<!--enumerable: false,-->
<!--configurable: false-->
<!--},-->
<!--fn: {-->
<!--writable: false,-->
<!--enumerable: false,-->
<!--configurable: false-->
<!--},-->
<!--deps: {-->
<!--writable: true,-->
<!--enumerable: false,-->
<!--configurable: false-->
<!--},-->
<!--constructor: {-->
<!--writable: false,-->
<!--enumerable: false,-->
<!--configurable: false-->
<!--}-->
<!--});-->
<!--}-->

<!--function Atom(fn) {-->
<!--/*this.value = fn();-->
<!--this.fn = fn;-->
<!--this.deps = [];-->
<!--this.constructor = {name: this.value + ''};-->
<!--for (var i = 1; i < arguments.length; i++) {-->
<!--var arg = arguments[i];-->
<!--arg.deps.push(this);-->
<!--}-->
<!--*/-->

<!--var o = {fn: fn/*, constructor: this.constructor, __proto__: Atom.prototype*/};-->
<!--//        setNonEnumerableProps(o);-->
<!--return o;-->
<!--}-->
<!--Atom.prototype.set = function setValue(value) {-->
<!--this.value = value;-->
<!--this.constructor.name = value + '';-->
<!--for (var i = 0; i < this.deps.length; i++) {-->
<!--this.deps[i].set(this.deps[i].fn());-->
<!--/*-->
<!--this.deps[i].value = this.deps[i].fn();-->
<!--this.deps[i].constructor.name = this.deps[i].value + '';-->
<!--*/-->
<!--}-->
<!--return value;-->
<!--};-->

<!--Atom.prototype.valueOf = function valueOf() {-->
<!--return this.value;-->
<!--};-->

<!--Atom.prototype.toString = function toString() {-->
<!--return this.value;-->
<!--};-->


<!--/*-->
<!--console.time('perf2');-->

<!--var a = [0];-->

<!--for (var i = 1; i < 1000000; i++) {-->
<!--a[i] = a[i - 1] + 1;-->
<!--}-->
<!--console.timeEnd('perf2');-->

<!--console.time('perf');-->
<!--var a = [ Atom(function () {-->
<!--return 0;-->
<!--})];-->
<!--for (var i = 1; i < 1000000; i++) {-->

<!--a[i] = Atom(function abc() {-->
<!--return 1;-->
<!--}, a[i] - 1);-->
<!--}-->
<!--console.timeEnd('perf');-->
<!--*/-->


<!--</script>-->
</body>
</html>